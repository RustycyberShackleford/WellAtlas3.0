
<!doctype html><html><head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WellAtlas 3.0</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head><body>
  <div class="header-top"><h1 id="appTitle">WellAtlas 3.0</h1></div>
  <div class="header-sub">
    <select id="customerSelect"><option value="">Customer ‚ñæ</option></select>
    <select id="siteSelect" disabled><option value="">Site ‚ñæ</option></select>
    <select id="categorySelect">
      <option value="">Category ‚ñæ</option>
      <option>Domestic</option>
      <option>Drilling</option>
      <option>Ag</option>
      <option>Electrical</option>
    </select>
    <input id="searchInput" type="text" placeholder="Search (customers, sites, jobs, notes)">
    <button class="btn blue" id="goBtn" type="button">Search</button>
    <button class="btn gray" id="locateBtn" type="button">üìç Center on Me</button>
    <a class="btn green" href="/customers">Customers</a>
  </div>
  <main><div id="map"></div></main>

<script>
const mtKey = "{{ maptiler_key }}";
const hybrid  = L.tileLayer(`https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=${mtKey}`);
const streets = L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${mtKey}`);
const satellite = L.tileLayer(`https://api.maptiler.com/tiles/satellite-v2/{z}/{x}/{y}.jpg?key=${mtKey}`);
const map = L.map('map', { center:[39.9,-122.0], zoom:9, layers:[hybrid] });
L.control.layers({ "Hybrid":hybrid, "Streets":streets, "Satellite":satellite }).addTo(map);
let markersLayer = L.layerGroup().addTo(map), markers=[];

function addMarker(site){
  if(site.latitude==null || site.longitude==null) return;
  const m = L.marker([site.latitude, site.longitude]).bindPopup(`<strong>${site.customer} ‚Äî ${site.name}</strong><br>(${site.latitude.toFixed(5)}, ${site.longitude.toFixed(5)})<br><a href="/site/${site.id}">Open site</a>`);
  markersLayer.addLayer(m); markers.push(m);
}

async function loadCustomers(){
  const r = await fetch('/api/customers'); const data = await r.json();
  document.getElementById('customerSelect').innerHTML = '<option value="">Customer ‚ñæ</option>' + data.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}

async function loadSitesForCustomer(customerId){
  const r = await fetch(`/api/sites_for?customer_id=${customerId}`); const data = await r.json();
  const sel = document.getElementById('siteSelect');
  sel.disabled = false;
  sel.innerHTML = '<option value="">Site ‚ñæ</option>' + data.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}

async function refresh(){
  markersLayer.clearLayers(); markers=[];
  const q = document.getElementById('searchInput').value||"";
  const custSel = document.getElementById('customerSelect');
  const customerName = custSel.options[custSel.selectedIndex]?.text||"";
  const siteId = document.getElementById('siteSelect').value || "";
  const cat = document.getElementById('categorySelect').value || "";
  const r = await fetch(`/api/sites?q=${encodeURIComponent(q)}&customer=${encodeURIComponent(customerName==="Customer ‚ñæ"?"":customerName)}&category=${encodeURIComponent(cat)}&site_id=${encodeURIComponent(siteId)}`);
  const data = await r.json(); data.forEach(addMarker);
  if(markers.length){ const g=L.featureGroup(markers); map.fitBounds(g.getBounds().pad(0.2)); } else { map.setView([39.9,-122.0], 9); }
}

document.getElementById('goBtn').addEventListener('click', refresh);
document.getElementById('searchInput').addEventListener('keyup', e=>{ if(e.key==='Enter') refresh(); });
document.getElementById('customerSelect').addEventListener('change', (e)=>{
  const v = e.target.value;
  document.getElementById('siteSelect').disabled = !v;
  document.getElementById('siteSelect').innerHTML = '<option value="">Site ‚ñæ</option>';
  if(v) loadSitesForCustomer(v).then(refresh); else refresh();
});
document.getElementById('siteSelect').addEventListener('change', refresh);
document.getElementById('categorySelect').addEventListener('change', refresh);
document.getElementById('locateBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Geolocation not supported');
  navigator.geolocation.getCurrentPosition(pos=>{ map.setView([pos.coords.latitude,pos.coords.longitude],14); }, _=>alert('Location error'));
});
loadCustomers().then(refresh);
</script>
</body></html>
