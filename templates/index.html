
<!doctype html><html><head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>WellAtlas 3.0</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
</head><body>
  <div class="header-top"><h1 id="appTitle">WellAtlas 3.0</h1></div>
  <div class="header-sub input-row">
    <a class="btn blue" href="{{ url_for('customers_index') }}">Customers</a>
    <a class="btn amber" href="{{ url_for('jobs_index') }}">Job #</a>
    <select id="customerSelect"><option value="">Customer ‚ñæ</option></select>
    <select id="siteSelect" disabled><option value="">Site ‚ñæ</option></select>
    <select id="jobSelect" disabled><option value="">Job # ‚ñæ</option></select>
    <input id="searchInput" type="text" placeholder="Search all (customers, sites, jobs, descriptions, notes)">
    <button class="btn blue" id="goBtn" type="button">Search</button>
    <button class="btn gray" id="locateBtn" type="button">üìç Center on Me</button>
  </div>
  <main><div id="map"></div></main>
<script>
const mtKey = "{{ maptiler_key }}";
const streets = L.tileLayer(`https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=${mtKey}`);
const hybrid  = L.tileLayer(`https://api.maptiler.com/maps/hybrid/{z}/{x}/{y}.jpg?key=${mtKey}`);
const satellite = L.tileLayer(`https://api.maptiler.com/tiles/satellite-v2/{z}/{x}/{y}.jpg?key=${mtKey}`);
const map = L.map('map', { center:[39.9,-122.0], zoom:9, layers:[hybrid] });
L.control.layers({ "Hybrid":hybrid, "Streets":streets, "Satellite":satellite }).addTo(map);
let markersLayer = L.layerGroup().addTo(map), markers=[];

function addMarker(site){
  if(site.latitude==null || site.longitude==null) return;
  const m = L.marker([site.latitude, site.longitude]).bindPopup(`<strong>${site.customer} ‚Äî ${site.name}</strong><br>(${site.latitude.toFixed(5)}, ${site.longitude.toFixed(5)})<br><a href="/site/${site.id}">Open site</a>`);
  markersLayer.addLayer(m); markers.push(m);
}
async function loadCustomers(){
  const r = await fetch('/api/customers'); const data = await r.json();
  document.getElementById('customerSelect').innerHTML = '<option value="">Customer ‚ñæ</option>' + data.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}
async function loadSites(customerId){
  const r = await fetch(`/api/sites_for?customer_id=${customerId}`); const data = await r.json();
  const sel = document.getElementById('siteSelect');
  sel.disabled = false;
  sel.innerHTML = '<option value="">Site ‚ñæ</option>' + data.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
  document.getElementById('jobSelect').innerHTML = '<option value="">Job # ‚ñæ</option>'; document.getElementById('jobSelect').disabled=true;
}
async function loadJobs(siteId){
  const r = await fetch(`/api/jobs_for?site_id=${siteId}`); const data = await r.json();
  const sel = document.getElementById('jobSelect');
  sel.disabled=false;
  sel.innerHTML = '<option value="">Job # ‚ñæ</option>' + data.map(j=>`<option value="${j.id}">${j.job_number}</option>`).join('');
}
async function refresh(){
  markersLayer.clearLayers(); markers=[];
  const q = document.getElementById('searchInput').value||"";
  const custSel = document.getElementById('customerSelect'); const custName = custSel.options[custSel.selectedIndex]?.text||"";
  const r = await fetch(`/api/sites?q=${encodeURIComponent(q)}&customer=${encodeURIComponent(custName==="Customer ‚ñæ"?"":custName)}`);
  const data = await r.json(); data.forEach(addMarker);
  if(markers.length){ const g=L.featureGroup(markers); map.fitBounds(g.getBounds().pad(0.2)); } else { map.setView([39.9,-122.0], 9); }
}
document.getElementById('goBtn').addEventListener('click', refresh);
document.getElementById('searchInput').addEventListener('keyup', e=>{ if(e.key==='Enter') refresh(); });
document.getElementById('customerSelect').addEventListener('change', (e)=>{
  const v = e.target.value;
  if(!v){ document.getElementById('siteSelect').disabled=true; document.getElementById('jobSelect').disabled=true; refresh(); return; }
  loadSites(v).then(refresh);
});
document.getElementById('siteSelect').addEventListener('change', (e)=>{
  const v = e.target.value;
  if(!v){ document.getElementById('jobSelect').disabled=true; refresh(); return; }
  loadJobs(v).then(refresh);
});
document.getElementById('jobSelect').addEventListener('change', (e)=>{
  const v = e.target.value;
  if(v){ window.location.href = `/site/${document.getElementById('siteSelect').value}/job/${v}`; }
});
document.getElementById('locateBtn').addEventListener('click', ()=>{
  if(!navigator.geolocation) return alert('Geolocation not supported');
  navigator.geolocation.getCurrentPosition(pos=>{ map.setView([pos.coords.latitude,pos.coords.longitude],14); }, _=>alert('Location error'));
});

loadCustomers().then(refresh);
</script>
</body></html>
